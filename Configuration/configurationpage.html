<div id="UpscalerConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage">
    <div data-role="content">
        <div class="content-primary">
            <div class="verticalSection">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">üéÆ AI Upscaler Plugin</h2>
                    <span class="bubble ml-1">v1.5.0.8</span>
                </div>
                <p class="sectionDescription">Professional AI Video Enhancement for Jellyfin - Docker Microservice
                    Architecture</p>
            </div>

            <form id="UpscalerConfigForm">
                <!-- Docker AI Service Section -->
                <div class="verticalSection"
                    style="background: linear-gradient(135deg, #1e3a5f 0%, #0f1f3a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h2 class="sectionTitle" style="color: #7dd3fc;">üê≥ Docker AI Service</h2>

                    <div class="inputContainer">
                        <label class="inputLabel" for="AiServiceUrl">AI Service URL:</label>
                        <input is="emby-input" type="text" id="AiServiceUrl" name="AiServiceUrl"
                            placeholder="http://localhost:5000" />
                        <div class="fieldDescription" style="color: #94a3b8;">URL to Docker AI Container (Default:
                            http://localhost:5000)</div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                        <button is="emby-button" type="button" id="btn-test-connection" class="raised">
                            <span>üîó Test Connection</span>
                        </button>
                        <div id="serviceStatus"
                            style="flex: 1; padding: 0.5rem; border-radius: 4px; background: rgba(0,0,0,0.3);">
                            <span id="serviceStatusText">Click 'Test Connection' to verify</span>
                        </div>
                    </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">‚öôÔ∏è Basic Settings</h2>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="EnablePlugin" name="EnablePlugin" />
                            <span>Enable AI Upscaler Plugin</span>
                        </label>
                        <div class="fieldDescription">Master switch to enable or disable the plugin</div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="PlayerButton" name="PlayerButton" />
                            <span>Show AI Button in Video Player</span>
                        </label>
                        <div class="fieldDescription">Adds the AI upscaling button to video player controls</div>
                    </div>

                    <div class="selectContainer">
                        <label class="selectLabel" for="Model">Default AI Model:</label>
                        <select is="emby-select" id="Model" name="Model">
                            <!-- Models will be loaded dynamically -->
                        </select>
                        <div class="fieldDescription">Select the primary AI model for video upscaling</div>
                    </div>

                    <div class="flex align-items-center justify-content-center flex-wrap-wrap">
                        <div class="selectContainer flex-grow-1 mr-1">
                            <label class="selectLabel" for="ScaleFactor">Scale Factor:</label>
                            <select is="emby-select" id="ScaleFactor" name="ScaleFactor">
                                <option value="2">2x Upscaling</option>
                                <option value="3">3x Upscaling</option>
                                <option value="4">4x Upscaling</option>
                            </select>
                        </div>
                        <div class="selectContainer flex-grow-1 ml-1">
                            <label class="selectLabel" for="QualityLevel">Quality Level:</label>
                            <select is="emby-select" id="QualityLevel" name="QualityLevel">
                                <option value="high">High Quality (Best Results)</option>
                                <option value="medium">Medium Quality (Balanced)</option>
                                <option value="low">Low Quality (Fastest)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üîß Hardware Settings</h2>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="HardwareAcceleration"
                                name="HardwareAcceleration" />
                            <span>Enable Hardware Acceleration</span>
                        </label>
                        <div class="fieldDescription">Use GPU for faster processing when available</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="MaxVRAMUsage">Max VRAM Usage (MB):</label>
                        <input is="emby-input" type="number" id="MaxVRAMUsage" name="MaxVRAMUsage" min="512"
                            max="32768" />
                        <div class="fieldDescription">Maximum VRAM to use for upscaling</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="CpuThreads">CPU Threads:</label>
                        <input is="emby-input" type="number" id="CpuThreads" name="CpuThreads" min="1" max="64" />
                        <div class="fieldDescription">Number of CPU threads for processing</div>
                    </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üéÆ Player Integration</h2>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="Notifications" name="Notifications" />
                            <span>Enable Progress Notifications</span>
                        </label>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="AutoRetryButton" name="AutoRetryButton" />
                            <span>Auto-Retry Button Injection</span>
                        </label>
                    </div>

                    <div class="selectContainer">
                        <label class="selectLabel" for="ButtonPosition">Button Position:</label>
                        <select is="emby-select" id="ButtonPosition" name="ButtonPosition">
                            <option value="right">Right Side</option>
                            <option value="left">Left Side</option>
                            <option value="center">Center</option>
                        </select>
                    </div>
                </div>
                <div class="verticalSection">
  <h2 class="sectionTitle">üé¨ Player Integration Preview</h2>

  <div id="player-preview-container" class="player-preview">
    <div class="mock-video-surface">
      <div class="mock-controls">
        <button class="mock-btn">‚èØ</button>
        <button class="mock-btn">‚èÆ</button>
        <button class="mock-btn">‚è≠</button>

        <!-- AI button gets injected here -->
        <div class="mock-right-controls"></div>
      </div>
    </div>
  </div>

  <div class="fieldDescription">
    This is a visual preview only. It confirms that the player integration script
    loads and injects UI correctly.
  </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üõ†Ô∏è Advanced Features</h2>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="EnableComparisonView"
                                name="EnableComparisonView" />
                            <span>Enable Comparison View</span>
                        </label>
                        <div class="fieldDescription">Show side-by-side comparison tools in the dashboard</div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="EnablePerformanceMetrics"
                                name="EnablePerformanceMetrics" />
                            <span>Enable Performance Metrics</span>
                        </label>
                        <div class="fieldDescription">Collect and display processing performance data</div>
                    </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üíæ Cache Settings</h2>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="EnablePreProcessingCache"
                                name="EnablePreProcessingCache" />
                            <span>Enable Pre-Processing Cache</span>
                        </label>
                        <div class="fieldDescription">Cache upscaled frames to improve repeat playback performance</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="MaxCacheAgeDays">Max Cache Age (Days):</label>
                        <input is="emby-input" type="number" id="MaxCacheAgeDays" name="MaxCacheAgeDays" min="1"
                            max="365" />
                        <div class="fieldDescription">Automatically remove cached items older than this</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="CacheSizeMB">Cache Size Limit (MB):</label>
                        <input is="emby-input" type="number" id="CacheSizeMB" name="CacheSizeMB" min="128"
                            max="1048576" />
                        <div class="fieldDescription">Maximum storage space to use for the AI cache</div>
                    </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üé¨ FFmpeg Live-Transcoding Wrapper</h2>
                    <p class="sectionDescription">Inject AI upscaling filters into live FFmpeg transcoding streams</p>

                    <div class="paperList">
                        <div class="listItem">
                            <div class="listItemBody two-line">
                                <h3 class="listItemBodyText">Wrapper Status</h3>
                                <div id="wrapper-status" class="listItemBodyText secondary">Checking...</div>
                            </div>
                        </div>
                        <div class="listItem">
                            <div class="listItemBody two-line">
                                <h3 class="listItemBodyText">Platform</h3>
                                <div id="wrapper-platform" class="listItemBodyText secondary">Unknown</div>
                            </div>
                        </div>
                        <div class="listItem" id="wrapper-path-container" style="display:none;">
                            <div class="listItemBody two-line">
                                <h3 class="listItemBodyText">Wrapper Path</h3>
                                <div id="wrapper-path" class="listItemBodyText secondary"
                                    style="word-break: break-all;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="fieldDescription" style="margin-top: 1em;">
                        <strong>‚ö†Ô∏è How it works:</strong> The wrapper script intercepts FFmpeg calls from Jellyfin and
                        injects hardware upscaling filters.
                        After installation, you must manually update Jellyfin's FFmpeg path in Dashboard ‚Üí Playback ‚Üí
                        Transcoding.
                    </div>

                    <div class="flex align-items-center justify-content-center flex-wrap-wrap"
                        style="margin-top: 1em; gap: 0.5em;">
                        <button is="emby-button" type="button" id="btn-install-wrapper"
                            class="raised button-submit block">
                            <span>Install Wrapper</span>
                        </button>
                        <button is="emby-button" type="button" id="btn-uninstall-wrapper" class="raised block"
                            style="background: #d32f2f;">
                            <span>Uninstall Wrapper</span>
                        </button>
                        <button is="emby-button" type="button" id="btn-regenerate-wrapper" class="raised block">
                            <span>Regenerate Script</span>
                        </button>
                    </div>

                    <div id="wrapper-message" class="fieldDescription"
                        style="margin-top: 1em; padding: 1em; border-radius: 4px; display: none;"></div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üìä Live Hardware Status</h2>
                    <div id="hardwareStatusContainer"
                        class="flex align-items-center justify-content-center flex-wrap-wrap">
                        <div class="card p-1 m-0-5 flex-grow-1" style="background: rgba(0, 164, 220, 0.1);">
                            <h3 style="color: #00a4dc; margin: 0;">CPU</h3>
                            <p id="cpu-status-text">Detecting...</p>
                        </div>
                        <div class="card p-1 m-0-5 flex-grow-1" style="background: rgba(0, 164, 220, 0.1);">
                            <h3 style="color: #00a4dc; margin: 0;">GPU</h3>
                            <p id="gpu-status-text">Detecting...</p>
                        </div>
                    </div>
                </div>

                <div class="verticalSection">
                    <h2 class="sectionTitle">üîç AI Comparison Preview</h2>
                    <div class="selectContainer">
                        <label class="selectLabel" for="comparison-item">Select Media Item:</label>
                        <div class="flex align-items-center">
                            <select is="emby-select" id="comparison-item" class="flex-grow-1">
                                <option value="">Loading items...</option>
                            </select>
                            <button is="emby-button" type="button" class="raised button-submit ml-1" id="btn-compare">
                                ‚ú® Generate Preview
                            </button>
                        </div>
                    </div>

                    <div id="comparison-result" class="hide mt-1">
                        <div class="flex align-items-center justify-content-center flex-wrap-wrap">
                            <div class="p-0-5 flex-grow-1" style="max-width: 50%;">
                                <h4 style="text-align: center;">Original</h4>
                                <img id="img-original" style="width: 100%; border-radius: 4px;" />
                            </div>
                            <div class="p-0-5 flex-grow-1" style="max-width: 50%;">
                                <h4 style="text-align: center;">AI Upscaled (x<span id="display-scale"></span>)</h4>
                                <img id="img-upscaled"
                                    style="width: 100%; border-radius: 4px; border: 2px solid #00a4dc;" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="formSubmitContainer">
                    <button is="emby-button" type="submit" class="raised button-submit block">
                        <span>üíæ Save Configuration</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            'use strict';

            const pluginId = 'f87f700e-679d-43e6-9c7c-b3a410dc3f22';
            let initialized = false;

            // Helper functions for Jellyfin API compatibility
            function showLoading() {
                if (typeof Dashboard.showLoadingMsg === 'function') {
                    Dashboard.showLoadingMsg();
                } else if (typeof Dashboard.showLoading === 'function') {
                    Dashboard.showLoading();
                }
            }

            function hideLoading() {
                if (typeof Dashboard.hideLoadingMsg === 'function') {
                    Dashboard.hideLoadingMsg();
                } else if (typeof Dashboard.hideLoading === 'function') {
                    Dashboard.hideLoading();
                }
            }

            function loadConfig(page) {
                showLoading();
                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    console.log('AI Upscaler: Config loaded', config);

                    // AI Service URL (Docker)
                    page.querySelector('#AiServiceUrl').value = config.AiServiceUrl || 'http://localhost:5000';

                    page.querySelector('#EnablePlugin').checked = config.EnablePlugin;
                    page.querySelector('#PlayerButton').checked = config.PlayerButton;
                    page.querySelector('#Model').value = config.Model || 'realesrgan';
                    page.querySelector('#ScaleFactor').value = config.ScaleFactor || 2;
                    page.querySelector('#QualityLevel').value = config.QualityLevel || 'medium';
                    page.querySelector('#HardwareAcceleration').checked = config.HardwareAcceleration;
                    page.querySelector('#MaxVRAMUsage').value = config.MaxVRAMUsage || 2048;
                    page.querySelector('#CpuThreads').value = config.CpuThreads || 4;
                    page.querySelector('#Notifications').checked = config.Notifications;
                    page.querySelector('#AutoRetryButton').checked = config.AutoRetryButton;
                    page.querySelector('#ButtonPosition').value = config.ButtonPosition || 'right';

                    // Advanced & Features
                    page.querySelector('#EnableComparisonView').checked = config.EnableComparisonView;
                    page.querySelector('#EnablePerformanceMetrics').checked = config.EnablePerformanceMetrics;

                    // Cache
                    page.querySelector('#EnablePreProcessingCache').checked = config.EnablePreProcessingCache;
                    page.querySelector('#MaxCacheAgeDays').value = config.MaxCacheAgeDays || 30;
                    page.querySelector('#CacheSizeMB').value = config.CacheSizeMB || 5120;

                    Dashboard.hideLoadingMsg();

                    //call check serverstatus
                    checkServiceStatus(page, config.AiServiceUrl || 'http://localhost:5000');

                }).catch(function (err) {
                    console.error('AI Upscaler: Failed to load config', err);
                    Dashboard.hideLoadingMsg();
                });
            }


            function loadModels(page) {
                return ApiClient.getJSON(ApiClient.getUrl('api/Upscaler/models')).then(function (data) {
                    // Handle both { items: [] } and direct [] responses
                    const models = Array.isArray(data) ? data : (data.items || []);
                    window.upscalerModels = models;

                    const select = page.querySelector('#Model');
                    let html = '';

                    if (models.length > 0) {
                        for (var i = 0; i < models.length; i++) {
                            var m = models[i];
                            // Use || to handle different C# serialization casings (Id vs id)
                            var id = m.Id || m.id || '';
                            var name = m.Name || m.name || 'Unknown Model';
                            var description = m.Description || m.description || '';
                            html += '<option value="' + id + '">' + name + "-" + description + '</option>';
                        }
                    } else {
                        html = '<option value="">No Models Found</option>';
                    }

                    select.innerHTML = html;

                    // Trigger the scale factor update for the first model
                    if (models.length > 0) {
                        updateScaleFactors(page, select.value);
                    }
                }).catch(function (err) {
                    console.error('Failed to load models:', err);
                    page.querySelector('#Model').innerHTML = '<option value="">Error loading models</option>';
                });
            }

            function updateScaleFactors(page, modelId) {
                // If we haven't loaded models into the window global yet, exit
                if (!window.upscalerModels) return;

                // Find the specific model data from our stored list
                const model = window.upscalerModels.find(m => (m.Id || m.id) === modelId);
                if (!model) return;

                const scaleSelect = page.querySelector('#ScaleFactor');
                const currentValue = scaleSelect.value;

                // Build options based on what the specific model supports (e.g., [2, 4])
                const scales = model.Scale || model.scale || [2, 4];

                let html = '';
                scales.forEach(s => {
                    html += '<option value="' + s + '">' + s + 'x Upscaling</option>';
                });

                scaleSelect.innerHTML = html;

                // Restore the previous selection if it's still a valid option for this model
                if (scales.includes(parseInt(currentValue))) {
                    scaleSelect.value = currentValue;
                }
            }

            // 2. AUTHENTICATED LOADER (Fixed the 401 Unauthorized error)
            function loadJavaScriptComponents() {
                const components = [
                    { id: 'aiupscaler-sidebar', name: 'sidebar-upscaler.js' },
                    { id: 'aiupscaler-quickmenu', name: 'quick-menu.js' },
                    { id: 'aiupscaler-player', name: 'player-integration.js' }
                ];

                components.forEach(component => {
                    const url = ApiClient.getUrl('api/Upscaler/js/' + component.name);

                    // Use ApiClient.ajax to automatically include the auth token
                    ApiClient.ajax({
                        type: 'GET',
                        url: url,
                        dataType: 'text'
                    }).then(script => {
                        const existing = document.getElementById(component.id);
                        if (existing) existing.remove();

                        const scriptElement = document.createElement('script');
                        scriptElement.id = component.id;
                        scriptElement.textContent = script;
                        document.head.appendChild(scriptElement);
                        console.log('AI Upscaler: Component ' + component.name + ' injected');
                    }).catch(err => console.error('AI Upscaler Auth: Failed to inject ' + component.name, err));
                });
            }

            function loadMediaItems(page) {
                ApiClient.getItems(ApiClient.getCurrentUserId(), {
                    IncludeItemTypes: "Movie,Episode",
                    Recursive: true,
                    Limit: 20,
                    SortBy: "DateCreated",
                    SortOrder: "Descending",
                    ImageTypes: "Primary"
                }).then(function (result) {
                    const select = page.querySelector('#comparison-item');

                    if (result.Items && result.Items.length > 0) {
                        select.innerHTML = result.Items.map(item => {
                            // Escape name to prevent XSS and ensure year is handled as a string
                            const name = item.Name || 'Unknown Title';
                            const year = item.ProductionYear ? ` (${item.ProductionYear})` : '';
                            return `<option value="${item.Id}">${name}${year}</option>`;
                        }).join('');
                    } else {
                        // FIX: We use a placeholder that doesn't trigger Jellyfin's auto-translation lookup
                        // Adding a non-breaking space or a specific character usually bypasses the "Key Missing" warning
                        select.innerHTML = '<option value="">(No media items found)</option>';
                    }
                }).catch(err => {
                    console.error('AI Upscaler: Error loading media items', err);
                    const select = page.querySelector('#comparison-item');
                    if (select) select.innerHTML = '<option value="">Error loading items</option>';
                });
            }

            function updateHardwareStatus(page) {
                ApiClient.getJSON(ApiClient.getUrl('api/Upscaler/recommendations')).then(function (data) {
                    if (data && data.hardwareInfo) {
                        page.querySelector('#cpu-status-text').textContent = data.hardwareInfo.detectedCPU;
                        page.querySelector('#gpu-status-text').textContent = data.hardwareInfo.detectedGPU;
                    }
                });
            }

            function generateComparison(page) {
                const itemId = page.querySelector('#comparison-item').value;
                if (!itemId) return;

                const btn = page.querySelector('#btn-compare');
                btn.disabled = true;
                btn.textContent = '‚åõ Processing...';

                const model = page.querySelector('#Model').value;
                const scale = page.querySelector('#ScaleFactor').value;
                page.querySelector('#display-scale').textContent = scale;

                const url = ApiClient.getUrl('api/Upscaler/compare/' + itemId, {
                    model: model,
                    scale: scale
                });

                ApiClient.getJSON(url).then(function (data) {
                    if (data && data.upscaledBase64) {
                        page.querySelector('#img-original').src = data.originalBase64;
                        page.querySelector('#img-upscaled').src = data.upscaledBase64;
                        page.querySelector('#comparison-result').classList.remove('hide');
                    }
                    btn.disabled = false;
                    btn.textContent = '‚ú® Generate Preview';
                }).catch(function () {
                    btn.disabled = false;
                    btn.textContent = '‚ú® Generate Preview';
                    Dashboard.alert('Comparison failed. Check logs.');
                });
            }

            function loadWrapperStatus(page) {
                ApiClient.getJSON(ApiClient.getUrl('api/upscaler/wrapper/status')).then(function (data) {
                    const statusEl = page.querySelector('#wrapper-status');
                    const platformEl = page.querySelector('#wrapper-platform');
                    const pathEl = page.querySelector('#wrapper-path');
                    const pathContainer = page.querySelector('#wrapper-path-container');

                    statusEl.textContent = data.IsInstalled ? '‚úÖ Installed & Active' : '‚ùå Not Installed';
                    platformEl.textContent = data.Platform + ' (' + data.RuntimeIdentifier + ')';

                    if (data.IsInstalled) {
                        pathEl.textContent = data.WrapperPath;
                        pathContainer.style.display = 'block';
                    } else {
                        pathContainer.style.display = 'none';
                    }
                }).catch(function () {
                    page.querySelector('#wrapper-status').textContent = '‚ö†Ô∏è Error loading status';
                });
            }

            function installWrapper(page) {
                const btn = page.querySelector('#btn-install-wrapper');
                const msgEl = page.querySelector('#wrapper-message');
                btn.disabled = true;

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('api/upscaler/wrapper/install')
                }).then(function (data) {
                    msgEl.textContent = data.Message;
                    msgEl.style.background = 'rgba(76, 175, 80, 0.2)';
                    msgEl.style.display = 'block';
                    loadWrapperStatus(page);
                    btn.disabled = false;
                }).catch(function () {
                    msgEl.textContent = 'Installation failed. Check server logs.';
                    msgEl.style.background = 'rgba(244, 67, 54, 0.2)';
                    msgEl.style.display = 'block';
                    btn.disabled = false;
                });
            }

            function uninstallWrapper(page) {
                const btn = page.querySelector('#btn-uninstall-wrapper');
                const msgEl = page.querySelector('#wrapper-message');
                btn.disabled = true;

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('api/upscaler/wrapper/uninstall')
                }).then(function (data) {
                    msgEl.textContent = data.Message;
                    msgEl.style.background = 'rgba(255, 152, 0, 0.2)';
                    msgEl.style.display = 'block';
                    loadWrapperStatus(page);
                    btn.disabled = false;
                }).catch(function () {
                    msgEl.textContent = 'Uninstallation failed. Check server logs.';
                    msgEl.style.background = 'rgba(244, 67, 54, 0.2)';
                    msgEl.style.display = 'block';
                    btn.disabled = false;
                });
            }

            function regenerateWrapper(page) {
                const btn = page.querySelector('#btn-regenerate-wrapper');
                const msgEl = page.querySelector('#wrapper-message');
                btn.disabled = true;

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('api/upscaler/wrapper/regenerate')
                }).then(function (data) {
                    msgEl.textContent = data.Message;
                    msgEl.style.background = 'rgba(33, 150, 243, 0.2)';
                    msgEl.style.display = 'block';
                    loadWrapperStatus(page);
                    btn.disabled = false;
                }).catch(function () {
                    msgEl.textContent = 'Regeneration failed. Check server logs.';
                    msgEl.style.background = 'rgba(244, 67, 54, 0.2)';
                    msgEl.style.display = 'block';
                    btn.disabled = false;
                });
            }

            function checkServiceStatus(page) {
                const statusText = page.querySelector('#serviceStatusText');
                const serviceUrl = page.querySelector('#AiServiceUrl').value.trim().replace(/\/$/, '');

                if (!serviceUrl) {
                    statusText.textContent = '‚ùå No AI Service URL set';
                    statusText.style.color = '#f44336';
                    return;
                }

                statusText.textContent = 'Checking Docker AI Service...';
                statusText.style.color = '#eab308';

                // THE FIX: Use 'no-cors' mode. 
                // This tells the browser to send the request without demanding CORS headers.
                // Note: You won't be able to read the JSON body, but a successful 
                // opaque response confirms the server is alive.
                fetch(serviceUrl + '/health', {
                    method: 'GET',
                    mode: 'no-cors',
                    cache: 'no-cache'
                })
                    .then(() => {
                        // In no-cors mode, if the fetch doesn't throw an error, 
                        // the server responded (even if we can't see the status code).
                        statusText.textContent = '‚úÖ AI Service Reachable (Local/Tunnel)';
                        statusText.style.color = '#4caf50';
                    })
                    .catch(err => {
                        console.error('Docker service unreachable:', err);
                        statusText.textContent = '‚ùå Cannot reach Docker AI Service';
                        statusText.style.color = '#f44336';
                    });
            }

            function testConnection(page) {
                const btn = page.querySelector('#btn-test-connection');
                const statusEl = page.querySelector('#serviceStatusText');
                const statusContainer = page.querySelector('#serviceStatus');
                const url = page.querySelector('#AiServiceUrl').value || 'http://localhost:5000';

                btn.disabled = true;
                statusEl.textContent = 'Testing...';
                statusContainer.style.background = 'rgba(255, 193, 7, 0.2)';

                fetch(url + '/health', {
                    method: 'GET',
                    mode: 'no-cors', // Bypasses CORS policy for the connection test
                    cache: 'no-cache'
                }).then(function () {
                    btn.disabled = false;
                    statusEl.innerHTML = '‚úÖ Connection successful!';
                    statusContainer.style.background = 'rgba(76, 175, 80, 0.2)';
                }).catch(function (err) {
                    btn.disabled = false;
                    statusEl.innerHTML = '‚ùå Connection refused (Check Docker)';
                    statusContainer.style.background = 'rgba(244, 67, 54, 0.2)';
                });
            }

            // ===== CRITICAL: Save Configuration Handler =====
            function saveConfiguration(page) {
                console.log('AI Upscaler: Saving configuration...');
                showLoading();

                const config = {
                    // AI Service URL (Docker) - CRITICAL for plugin-container connection
                    AiServiceUrl: page.querySelector('#AiServiceUrl').value || 'http://localhost:5000',

                    EnablePlugin: page.querySelector('#EnablePlugin').checked,
                    PlayerButton: page.querySelector('#PlayerButton').checked,
                    Model: page.querySelector('#Model').value,
                    ScaleFactor: parseInt(page.querySelector('#ScaleFactor').value) || 2,
                    QualityLevel: page.querySelector('#QualityLevel').value,
                    HardwareAcceleration: page.querySelector('#HardwareAcceleration').checked,
                    MaxVRAMUsage: parseInt(page.querySelector('#MaxVRAMUsage').value) || 2048,
                    CpuThreads: parseInt(page.querySelector('#CpuThreads').value) || 4,
                    Notifications: page.querySelector('#Notifications').checked,
                    AutoRetryButton: page.querySelector('#AutoRetryButton').checked,
                    ButtonPosition: page.querySelector('#ButtonPosition').value,
                    EnableComparisonView: page.querySelector('#EnableComparisonView').checked,
                    EnablePerformanceMetrics: page.querySelector('#EnablePerformanceMetrics').checked,
                    EnablePreProcessingCache: page.querySelector('#EnablePreProcessingCache').checked,
                    MaxCacheAgeDays: parseInt(page.querySelector('#MaxCacheAgeDays').value) || 30,
                    CacheSizeMB: parseInt(page.querySelector('#CacheSizeMB').value) || 5120
                };

                console.log('AI Upscaler: Config to save:', config);

                ApiClient.updatePluginConfiguration(pluginId, config).then(function () {
                    console.log('AI Upscaler: Configuration saved successfully');
                    hideLoading();
                    // Dashboard.processPluginConfigurationUpdateResult();
                    Dashboard.alert('Settings saved successfully!');
                }).catch(function (err) {
                    console.error('AI Upscaler: Failed to save configuration', err);
                    hideLoading();
                    Dashboard.alert('Failed to save configuration: ' + (err.message || 'Unknown error'));
                });
            }

            function initializePage(page) {
                if (initialized) {
                    console.log('AI Upscaler: Page already initialized, skipping');
                    return;
                }
                initialized = true;
                console.log('AI Upscaler: Initializing configuration page');

                // ===== FORM SUBMIT HANDLER =====
                const form = page.querySelector('#UpscalerConfigForm');
                if (form && !form.dataset.handlerAttached) {
                    form.dataset.handlerAttached = 'true';

                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('AI Upscaler: Form submit triggered');
                        saveConfiguration(document.querySelector('#UpscalerConfigurationPage'));
                        return false;
                    });
                    console.log('AI Upscaler: Form submit handler attached');
                }

                // Model change handler
                const modelSelect = page.querySelector('#Model');
                if (modelSelect) {
                    modelSelect.addEventListener('change', function () {
                        updateScaleFactors(page, this.value);
                    });
                }

                // Test Connection button
                const btnTestConnection = page.querySelector('#btn-test-connection');
                if (btnTestConnection) {
                    btnTestConnection.addEventListener('click', function () {
                        testConnection(page);
                    });
                }

                // Compare button
                const btnCompare = page.querySelector('#btn-compare');
                if (btnCompare) {
                    btnCompare.addEventListener('click', function () {
                        generateComparison(page);
                    });
                }

                // Wrapper buttons
                const btnInstall = page.querySelector('#btn-install-wrapper');
                if (btnInstall) {
                    btnInstall.addEventListener('click', function () {
                        installWrapper(page);
                    });
                }

                const btnUninstall = page.querySelector('#btn-uninstall-wrapper');
                if (btnUninstall) {
                    btnUninstall.addEventListener('click', function () {
                        uninstallWrapper(page);
                    });
                }

                const btnRegenerate = page.querySelector('#btn-regenerate-wrapper');
                if (btnRegenerate) {
                    btnRegenerate.addEventListener('click', function () {
                        regenerateWrapper(page);
                    });
                }
            }

            function onPageShow(page) {
                console.log('AI Upscaler: Page show event');

                // Initialize immediately
                initializePage(page);

                // Chain loading to avoid race conditions
                loadModels(page).then(() => {
                    loadConfig(page);
                }).catch(() => {
                    loadConfig(page);
                });

                loadMediaItems(page);
                updateHardwareStatus(page);
                loadJavaScriptComponents();
                loadWrapperStatus(page);
            }

            // ===== EVENT BINDING =====
            const pageId = '#UpscalerConfigurationPage';
            const pageElement = document.querySelector(pageId);

            if (pageElement) {
                // Immediate initialization if page is already visible
                console.log('AI Upscaler: Page element found, binding events');

                // Try multiple event types for compatibility
                pageElement.addEventListener('pageshow', function () {
                    console.log('AI Upscaler: pageshow event');
                    onPageShow(this);
                });

                pageElement.addEventListener('viewshow', function () {
                    console.log('AI Upscaler: viewshow event');
                    onPageShow(this);
                });

                pageElement.addEventListener('pageinit', function () {
                    console.log('AI Upscaler: pageinit event');
                    initializePage(this);
                });

                // Fallback: Initialize immediately if events don't fire
                setTimeout(function () {
                    if (!initialized) {
                        console.log('AI Upscaler: Fallback initialization');
                        onPageShow(pageElement);
                    }
                }, 500);
            }
        })();
    </script>
</div>
